'use strict';

var promisify = require('promisify-es6');
var cleanCID = require('../clean-cid');
var TarStreamToObjects = require('../tar-stream-to-objects');
var v = require('is-ipfs');

module.exports = function (send) {
  return promisify(function (path, opts, callback) {
    if (typeof opts === 'function' && !callback) {
      callback = opts;
      opts = {};
    }

    // opts is the real callback --
    // 'callback' is being injected by promisify
    if (typeof opts === 'function' && typeof callback === 'function') {
      callback = opts;
      opts = {};
    }

    try {
      path = cleanCID(path);
    } catch (err) {
      if (!v.ipfsPath(path)) {
        return callback(err);
      }
    }

    var request = {
      path: 'get',
      args: path,
      qs: opts

      // Convert the response stream to TarStream objects
    };send.andTransform(request, TarStreamToObjects, callback);
  });
};